import{s as S,h as y,a as v,b as C}from"./xhrStatus.js";document.addEventListener("onImageSave",t=>{w(t.detail)});document.addEventListener("onCanvasStatusMessage",t=>{console.log("onCanvasStatusMessage:",t.detail)});document.addEventListener("onCloseImageEditor",t=>{const a=t.detail.imageEditorInstance,d=a.closest("[data-image-editor-modal]"),e=a.getAttribute("data-initiator-id");document.querySelector("#"+e).dispatchEvent(new CustomEvent("imageEditorModalCloseRequest",{bubbles:!0,composed:!0,detail:{modal:d}}))});const w=t=>{var p;const a=t.imageEditorInstance.closest("[data-image-editor-modal]"),d=a.querySelector("[data-image-editor-modal-config]");if(!d)return;let e={};try{e=JSON.parse(d.value),console.log(e)}catch{console.error("Invalid JSON config")}if(!e.useXhr){const n=t.file,i=a.querySelector("[data-image-editor-update-form]");let f=i.querySelector("[ data-image-editor-update-form-file]");if(!f)return;const g=new DataTransfer;g.items.add(n),f.files=g.files,i.submit();return}const r=document.querySelector("#"+e.initiatorId),I=r.querySelector("[data-status-area-container]"),{statusContainer:h,spinnerContainer:l}=M(r);S(l);const E=t.file,o=new FormData,b=e.mediumId??null,c=e.modelType,m=e.modelId??"",u=e.initiatorId;o.append("initiator_id",u),o.append("media_manager_id",e.mediaManagerId??""),o.append("model_type",c),o.append("model_id",m),o.append("single_medium_id",((p=e.singleMedium)==null?void 0:p.id)??null),o.append("medium_id",b),o.append("options",JSON.stringify(e.options)),o.append("collection",e.collection),o.append("temporary_upload_mode",e.temporaryUploadMode),o.append("file",E),Object.entries(e.collections).forEach(([n,i])=>{o.append(`collections[${n}]`,i)}),fetch(e.saveUpdatedMediumRoute,{method:"POST",headers:{"X-CSRF-TOKEN":e.csrfToken,Accept:"application/json"},body:o,cache:"no-store"}).then(async n=>{const i=await n.json();if(!n.ok)throw y(n,i,I),new Error("Update of medium failed");return i}).then(n=>{v(h,{type:"success",message:q("medium_replaced")}),console.log("fire events imageEditorModalCloseRequest and refreshRequest and onImageUpdated"),r.dispatchEvent(new CustomEvent("imageEditorModalCloseRequest",{bubbles:!0,composed:!0,detail:{modal:a}})),r.dispatchEvent(new CustomEvent("refreshRequest",{bubbles:!0,composed:!0,detail:{singleMediumId:n.singleMediumId??null}}));const i=n.newMediumId;console.log("newMediumId",i),document.dispatchEvent(new CustomEvent("imageUpdated",{bubbles:!1,detail:{mediumId:i,modelType:c,modelId:m,initiatorId:u}}))}).finally(()=>{C(l)})};function M(t){let a=t.querySelector("[data-status-area-container]"),d=a;const e=t.closest("[data-media-manager-lab]");if(e&&e!==t.closest("[data-media-manager-lab]:scope")){const s=e.querySelector("[data-status-area-container]");s&&(a=s,d=s)}return{statusContainer:a,spinnerContainer:d}}function q(t){var a;return((a=window.mediaLibraryTranslations)==null?void 0:a[t])||t}
