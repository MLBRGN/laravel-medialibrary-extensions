import{s as u,t as p,a as E,h as S,b as v}from"./xhrStatus.js";const w=document.querySelectorAll("[data-media-manager]");w.forEach(o=>{const e=o.querySelector("[data-media-manager-layout]");o.addEventListener("click",async function(t){const r=h(o);if(!r||!r.useXhr)return;const a=t.target.closest("[data-action]");if(!a)return;t.preventDefault();const n=a.getAttribute("data-action");if(n==="debugger-toggle"){const l=r.id;console.log("componentId",l);const d=document.querySelector("#"+l).querySelector(".mle-debug");console.log("debugSection",d),d.classList.toggle("hidden"),console.log("toggle debugger TODO");return}const s=a.closest("[data-xhr-form]"),g=(s==null?void 0:s.getAttribute("data-xhr-method"))??"post",m=A(n,a,r);if(!m){u(e,{type:"error",message:p("invalid_action")});return}E(e);try{const l=q(s),c=g.toUpperCase();["DELETE","PUT","PATCH"].includes(c)&&l.append("_method",c);const d=await fetch(m,{method:"POST",headers:{"X-CSRF-TOKEN":r.csrfToken,Accept:"application/json"},body:l}),f=await d.json();if(!d.ok){S(d,f,e);return}u(e,f),n!=="medium-restore"&&y(o,r,{}),_(s)}catch(l){console.error("Error during upload:",l),u(e,{type:"error",message:p("upload_failed")})}finally{v(e)}}),o.addEventListener("refreshRequest",function(t){const r=t.detail,i=h(o);y(o,i,r)})});function h(o){const e=o.querySelector("[data-media-manager-config]");if(!e)return null;try{return JSON.parse(e.value)}catch(t){return console.error(`Invalid JSON config for ${o.id}:`,t),null}}function A(o,e,t){var i,a,n;console.log("target",e),console.log("config",t);const r={"upload-media":t.mediaUploadRoute,"upload-youtube-medium":t.youtubeUploadRoute,"destroy-medium":(i=e==null?void 0:e.dataset)==null?void 0:i.route,"set-as-first":(a=e==null?void 0:e.dataset)==null?void 0:a.route,"medium-restore":(n=e==null?void 0:e.dataset)==null?void 0:n.route};return console.log("routes",r),r[o]||null}function y(o,e,t={}){const r=o.querySelector("[data-media-preview-grid]"),i=o.querySelectorAll("[data-form], [data-xhr-form]");if(!r)return;const a=new URLSearchParams({model_type:e.modelType,model_id:e.modelId,single_medium_id:t.singleMediumId??null,temporary_upload_mode:e.temporaryUploadMode,initiator_id:e.id,collections:JSON.stringify(e.collections),options:JSON.stringify(e.options)});fetch(`${e.previewUpdateRoute}?${a}`,{headers:{Accept:"application/json"}}).then(async n=>{const s=await n.json();if(!n.ok){S(n,s);return}return s}).then(n=>{n.html&&(r.innerHTML=n.html,e.multiple||n.mediaCount!==void 0&&n.mediaCount!==null&&(n.mediaCount<1?C(i):T(i)),document.dispatchEvent(new CustomEvent("mediaManagerPreviewsUpdated",{bubbles:!1,detail:{mediaManager:o,previewGrid:r}})))}).catch(n=>{console.error("Error refreshing media manager:",n)}).finally(()=>{})}function q(o){const e=new FormData;return o.querySelectorAll("input").forEach(t=>{t.type==="file"?Array.from(t.files).forEach(r=>{e.append(t.name,r)}):e.append(t.name,t.value)}),e}function _(o){o.querySelectorAll("input").forEach(e=>{e.type!=="hidden"&&(e.value="")})}function b(o,e){o.forEach(t=>{t.querySelectorAll('input:not([type="hidden"]), button').forEach(r=>r.disabled=e)})}function T(o){b(o,!0)}function C(o){b(o,!1)}
