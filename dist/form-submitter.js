document.addEventListener("DOMContentLoaded",function(){let h=null;document.querySelectorAll("[data-media-manager]").forEach(t=>{const e=t.id,a=t.querySelector(".media-manager-form"),r=t.querySelector(".media-manager-config");if(!r)return;let i={};try{i=JSON.parse(r.value)}catch(n){console.error(`Invalid JSON config for ${e}:`,n);return}const{id:d,model_type:_,model_id:S,image_collection:f,document_collection:L,youtube_collection:C,frontend_theme:M,destroy_enabled:R,set_as_first_enabled:D,show_media_url:I,show_order:F,media_upload_route:O,preview_refresh_route:j,youtube_upload_route:$,csrf_token:N}=i;t.addEventListener("click",function(n){const c=n.target.closest("[data-action]");if(!c)return;n.preventDefault();const p=c.getAttribute("data-action"),s=c.closest("[data-xhr-form]");A(a);const x=k(s),g={"upload-media":O,"upload-youtube-medium":$},y=c.closest(".media-manager-preview-media-container");y&&(g["destroy-medium"]=y.dataset.destroyRoute||"",g["set-as-first"]=y.dataset.setAsFirstRoute||"");const w=g[p];if(!w){m(a,{type:"error",message:"Invalid action"}),b(a);return}fetch(w,{method:"POST",headers:{"X-CSRF-TOKEN":N,Accept:"application/json"},body:x}).then(async l=>{const u=await l.json();if(!l.ok){T(l,u,a);return}m(a,u);const E=document.getElementById(s.dataset.target+"-flash");E&&u.message&&(E.innerHTML=`<div class="alert alert-${u.type}">${u.message}</div>`),U(),q(s)}).catch(l=>{console.error("Error during upload:",l)}).finally(()=>{b(a)})});function U(){const n=t.querySelector(".media-manager-preview-grid");if(!n)return;const c={model_type:_,model_id:S,image_collection:f,youtube_collection:C,document_collection:L,initiator_id:d,destroy_enabled:R==="true",set_as_first_enabled:D==="true",show_media_url:I==="true",show_order:F==="true",frontend_theme:M},p=new URLSearchParams(c);fetch(`${j}?${p}`,{headers:{Accept:"application/json"}}).then(s=>s.json()).then(s=>{n.innerHTML=s.html}).catch(s=>{console.error("Error refreshing media manager:",s)})}});function A(t){v(t);const e=t.querySelector("div[data-spinner-container]");e&&e.classList.add("active")}function b(t){const e=t.querySelector("div[data-spinner-container]");e&&e.classList.remove("active")}const m=(t,e)=>{const a=t.querySelector("[data-status-container]"),r=a==null?void 0:a.querySelector("[data-status-message]");if(!a||!r)return;const i=r.getAttribute("data-base-classes")||"",d=r.getAttribute("data-success-classes")||"",_=r.getAttribute("data-error-classes")||"";r.className=i,(e.type==="success"?d:_).split(" ").forEach(f=>{f.trim()&&r.classList.add(f.trim())}),r.textContent=e.message,a.classList.add("visible"),h&&clearTimeout(h),h=setTimeout(()=>{v(t)},5e3)},v=t=>{const e=t.querySelector("[data-status-container]");e&&e.classList.remove("visible")};function T(t,e,a){let r=o("upload_failed");switch(t.status){case 419:r=o("csrf_token_mismatch");break;case 401:r=o("unauthenticated");break;case 403:r=o("forbidden");break;case 404:r=o("not_found");break;case 422:if(e.errors){for(const i in e.errors)e.errors[i].forEach(d=>{m(a,{message:d,type:"error"})});return}r=e.message||o("validation_failed");break;case 429:r=o("too_many_requests");break;case 500:case 503:r=o("server_error");break;default:r=e.message||r;break}m(a,{message:r,type:"error"})}function o(t){var e;return((e=window.mediaLibraryTranslations)==null?void 0:e[t])||t}function k(t){const e=new FormData;return t.querySelectorAll("input").forEach(a=>{a.type==="file"?[...a.files].forEach(r=>{e.append(a.name,r)}):e.append(a.name,a.value)}),e}function q(t){t.querySelectorAll("input").forEach(e=>{e.type!=="hidden"&&(e.value="")})}});
