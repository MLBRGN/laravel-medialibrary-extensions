import{s as u,t as h,a as v,h as S,b as w}from"./xhrStatus.js";const A=document.querySelectorAll("[data-media-manager]");A.forEach(o=>{const e=o.querySelector(".media-manager-row");o.addEventListener("click",async function(r){const t=y(o);if(!t||!t.useXhr)return;const a=r.target.closest("[data-action]");if(!a)return;r.preventDefault();const s=a.getAttribute("data-action"),n=a.closest("[data-xhr-form]"),l=(n==null?void 0:n.getAttribute("data-xhr-method"))??"post",f=b(s,a,t);if(!f){u(e,{type:"error",message:h("invalid_action")});return}v(e);try{const i=R(n),p=l.toUpperCase();["DELETE","PUT","PATCH"].includes(p)&&i.append("_method",p);const c=await fetch(f,{method:"POST",headers:{"X-CSRF-TOKEN":t.csrfToken,Accept:"application/json"},body:i});console.log("response",c);const m=await c.json();if(!c.ok){S(c,m,e);return}u(e,m),E(o,t),F(n)}catch(i){console.error("Error during upload:",i),u(e,{type:"error",message:h("upload_failed")})}finally{w(e)}}),o.addEventListener("refreshRequest",function(r){const t=y(o);E(o,t)})});function y(o){const e=o.querySelector(".media-manager-config");if(!e)return null;try{return JSON.parse(e.value)}catch(r){return console.error(`Invalid JSON config for ${o.id}:`,r),null}}function b(o,e,r){var a,s,n,l;const t=e.closest(".media-manager-preview-media-container");return{"upload-media":r.mediaUploadRoute,"upload-youtube-medium":r.youtubeUploadRoute,"temporary-upload-destroy":(a=t==null?void 0:t.dataset)==null?void 0:a.temporaryUploadDestroyRoute,"destroy-medium":(s=t==null?void 0:t.dataset)==null?void 0:s.destroyRoute,"set-as-first":(n=t==null?void 0:t.dataset)==null?void 0:n.setAsFirstRoute,"temporary-upload-set-as-first":(l=t==null?void 0:t.dataset)==null?void 0:l.temporaryUploadSetAsFirstRoute}[o]||null}function E(o,e){const r=o.querySelector(".media-manager-preview-grid"),t=o.querySelectorAll("form, [data-xhr-form]");if(!r)return;const d=new URLSearchParams({model_type:e.modelType,model_id:e.modelId,temporary_upload_mode:e.temporaryUploadMode,initiator_id:e.id,collections:JSON.stringify(e.collections),options:JSON.stringify(e.options)});fetch(`${e.previewUpdateRoute}?${d}`,{headers:{Accept:"application/json"}}).then(async a=>{const s=await a.json();if(!a.ok){S(a,s);return}return s}).then(a=>{a.html&&(r.innerHTML=a.html,e.multiple||a.mediaCount!==void 0&&a.mediaCount!==null&&(a.mediaCount<1?q(t):U(t)),document.dispatchEvent(new CustomEvent("mediaManagerPreviewsUpdated",{bubbles:!1,detail:{mediaManager:o,previewGrid:r}})))}).catch(a=>{console.error("Error refreshing media manager:",a)}).finally(()=>{})}function R(o){const e=new FormData;return o.querySelectorAll("input").forEach(r=>{r.type==="file"?Array.from(r.files).forEach(t=>{e.append(r.name,t)}):e.append(r.name,r.value)}),console.log("formData",e),e.forEach((r,t)=>{console.log(t,r)}),e}function F(o){o.querySelectorAll("input").forEach(e=>{e.type!=="hidden"&&(e.value="")})}function g(o,e){o.forEach(r=>{console.log("forms",o,"form",r),r.querySelectorAll('input:not([type="hidden"]), button').forEach(t=>t.disabled=e)})}function U(o){g(o,!0)}function q(o){g(o,!1)}
