import{s as c,t as y,a as F,h as b,b as q}from"./xhrStatus.js";document.addEventListener("DOMContentLoaded",function(){document.querySelectorAll("[data-media-manager]").forEach(t=>{const e=t.querySelector(".media-manager-row");t.addEventListener("click",async function(r){const o=m(t);if(!o)return;const s=r.target.closest("[data-action]");if(!s)return;r.preventDefault();const a=s.getAttribute("data-action"),n=s.closest("[data-xhr-form]"),d=(n==null?void 0:n.getAttribute("data-xhr-method"))??"post",l=v(a,s,o);if(!l){c(e,{type:"error",message:y("invalid_action")});return}F(e);try{const i=w(n),h=d.toUpperCase();["DELETE","PUT","PATCH"].includes(h)&&i.append("_method",h);const u=await fetch(l,{method:"POST",headers:{"X-CSRF-TOKEN":o.csrf_token,Accept:"application/json"},body:i}),_=await u.json();if(!u.ok){b(u,_,e);return}c(e,_),p(t,o),E(n)}catch(i){console.error("Error during upload:",i),c(e,{type:"error",message:y("upload_failed")})}finally{q(e)}}),t.addEventListener("refreshRequest",function(r){const o=m(t);p(t,o)})});function m(t){const e=t.querySelector(".media-manager-config");if(!e)return null;try{return JSON.parse(e.value)}catch(r){return console.error(`Invalid JSON config for ${t.id}:`,r),null}}function v(t,e,r){var a,n,d,l;const o=e.closest(".media-manager-preview-media-container");return{"upload-media":r.media_upload_route,"upload-youtube-medium":r.youtube_upload_route,"temporary-upload-destroy":(a=o==null?void 0:o.dataset)==null?void 0:a.temporaryUploadDestroyRoute,"destroy-medium":(n=o==null?void 0:o.dataset)==null?void 0:n.destroyRoute,"set-as-first":(d=o==null?void 0:o.dataset)==null?void 0:d.setAsFirstRoute,"temporary-upload-set-as-first":(l=o==null?void 0:o.dataset)==null?void 0:l.temporaryUploadSetAsFirstRoute}[t]||null}function p(t,e){const r=t.querySelector(".media-manager-preview-grid"),o=t.querySelectorAll("form, [data-xhr-form]");if(!r)return;const s=new URLSearchParams({model_type:e.model_type,model_id:e.model_id,image_collection:e.image_collection,youtube_collection:e.youtube_collection,document_collection:e.document_collection,video_collection:e.video_collection,audio_collection:e.audio_collection,initiator_id:e.id,frontend_theme:e.frontend_theme,destroy_enabled:e.destroy_enabled,set_as_first_enabled:e.set_as_first_enabled,show_order:e.show_order,show_menu:e.show_menu,temporary_uploads:e.temporary_upload});fetch(`${e.preview_update_route}?${s}`,{headers:{Accept:"application/json"}}).then(async a=>{const n=await a.json();if(!a.ok){b(a,n);return}return n}).then(a=>{a.html&&(r.innerHTML=a.html,e.multiple||a.mediaCount!==void 0&&a.mediaCount!==null&&(a.mediaCount<1?A(o):S(o)),document.dispatchEvent(new CustomEvent("mediaManagerPreviewsUpdated",{bubbles:!1,detail:{mediaManager:t,previewGrid:r}})))}).catch(a=>{console.error("Error refreshing media manager:",a)}).finally(()=>{})}function w(t){const e=new FormData;return t.querySelectorAll("input").forEach(r=>{r.type==="file"?Array.from(r.files).forEach(o=>{e.append(r.name,o)}):e.append(r.name,r.value)}),e}function E(t){t.querySelectorAll("input").forEach(e=>{e.type!=="hidden"&&(e.value="")})}function f(t,e){t.forEach(r=>{r.querySelectorAll('input:not([type="hidden"]), button').forEach(o=>o.disabled=e)})}function S(t){f(t,!0)}function A(t){f(t,!1)}});
