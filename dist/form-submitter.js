document.addEventListener("DOMContentLoaded",function(){const h=document.querySelectorAll("[data-media-manager]");let p=null;h.forEach(a=>{const e=a.querySelector(".media-manager-form");a.addEventListener("click",async function(o){const t=b(a);if(!t)return;const r=o.target.closest("[data-action]");if(!r)return;o.preventDefault();const u=r.getAttribute("data-action");console.log("action",u);const n=r.closest("[data-xhr-form]"),i=(n==null?void 0:n.getAttribute("data-xhr-method"))??"post",_=g(u,r,t);if(!_){d(e,{type:"error",message:s("invalid_action")});return}A(e);try{const c=w(n);i.toLowerCase()==="delete"&&c.append("_method","DELETE"),i.toLowerCase()==="put"&&c.append("_method","PUT"),i.toLowerCase()==="patch"&&c.append("_method","PATCH");const m=await fetch(_,{method:"POST",headers:{"X-CSRF-TOKEN":t.csrf_token,Accept:"application/json"},body:c}),l=await m.json();if(!m.ok){E(m,l,e);return}d(e,l),v(a,t);const y=document.getElementById(`${n.dataset.target}-flash`);y&&l.message&&(y.innerHTML=`<div class="alert alert-${l.type}">${l.message}</div>`),S(n)}catch(c){console.error("Error during upload:",c),d(e,{type:"error",message:s("upload_failed")})}finally{L(e)}})});function b(a){const e=a.querySelector(".media-manager-config");if(!e)return null;try{return JSON.parse(e.value)}catch(o){return console.error(`Invalid JSON config for ${a.id}:`,o),null}}function g(a,e,o){const t=e.closest(".media-manager-preview-media-container"),r={"upload-media":o.media_upload_route,"upload-youtube-medium":o.youtube_upload_route};return t&&(r["temporary-upload-destroy"]=t.dataset.temporaryUploadDestroyRoute||"",r["destroy-medium"]=t.dataset.destroyRoute||"",r["set-as-first"]=t.dataset.setAsFirstRoute||"",r["temporary-upload-set-as-first"]=t.dataset.temporaryUploadSetAsFirstRoute||""),r[a]||null}function v(a,e){const o=a.querySelector(".media-manager-preview-grid");if(!o)return;const t=new URLSearchParams({model_type:e.model_type,model_id:e.model_id,image_collection:e.image_collection,youtube_collection:e.youtube_collection,document_collection:e.document_collection,initiator_id:e.id,frontend_theme:e.frontend_theme,destroy_enabled:e.destroy_enabled,set_as_first_enabled:e.set_as_first_enabled,show_media_url:e.show_media_url,show_order:e.show_order,temporary_uploads:e.temporary_upload});fetch(`${e.preview_update_route}?${t}`,{headers:{Accept:"application/json"}}).then(r=>r.json()).then(r=>{o.innerHTML=r.html}).catch(r=>{console.error("Error refreshing media manager:",r)})}function w(a){const e=new FormData;return a.querySelectorAll("input").forEach(o=>{o.type==="file"?Array.from(o.files).forEach(t=>{e.append(o.name,t)}):e.append(o.name,o.value)}),e}function S(a){a.querySelectorAll("input").forEach(e=>{e.type!=="hidden"&&(e.value="")})}function A(a){var e;f(a),(e=a.querySelector("[data-spinner-container]"))==null||e.classList.add("active")}function L(a){var e;(e=a.querySelector("[data-spinner-container]"))==null||e.classList.remove("active")}function d(a,{type:e,message:o}){const t=a.querySelector("[data-status-container]"),r=t==null?void 0:t.querySelector("[data-status-message]");if(!t||!r)return;const u=r.getAttribute("data-base-classes")||"",n=e==="success"?r.getAttribute("data-success-classes")||"":r.getAttribute("data-error-classes")||"";r.className=u,n.split(" ").forEach(i=>i&&r.classList.add(i)),r.textContent=o,t.classList.add("visible"),clearTimeout(p),p=setTimeout(()=>f(a),5e3)}function f(a){var e;(e=a.querySelector("[data-status-container]"))==null||e.classList.remove("visible")}function E(a,e,o){let t=s("upload_failed");switch(a.status){case 419:t=s("csrf_token_mismatch");break;case 401:t=s("unauthenticated");break;case 403:t=s("forbidden");break;case 404:t=s("not_found");break;case 422:if(e.errors){Object.values(e.errors).flat().forEach(r=>{d(o,{type:"error",message:r})});return}t=e.message||s("validation_failed");break;case 429:t=s("too_many_requests");break;case 500:case 503:t=s("server_error");break;default:t=e.message||t}d(o,{type:"error",message:t})}function s(a){var e;return((e=window.mediaLibraryTranslations)==null?void 0:e[a])||a}});
