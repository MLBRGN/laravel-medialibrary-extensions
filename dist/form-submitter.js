document.addEventListener("DOMContentLoaded",function(){const g=document.querySelectorAll("[data-media-manager]");let p=null;g.forEach(r=>{const e=r.querySelector(".media-manager-row");r.addEventListener("click",async function(a){const t=f(r);if(!t)return;const s=a.target.closest("[data-action]");if(!s)return;a.preventDefault();const n=s.getAttribute("data-action");console.log("action",n);const o=s.closest("[data-xhr-form]"),d=(o==null?void 0:o.getAttribute("data-xhr-method"))??"post",l=v(n,s,t);if(!l){u(e,{type:"error",message:c("invalid_action")});return}w(e);try{const i=S(o),y=d.toUpperCase();["DELETE","PUT","PATCH"].includes(y)&&i.append("_method",y);const m=await fetch(l,{method:"POST",headers:{"X-CSRF-TOKEN":t.csrf_token,Accept:"application/json"},body:i}),b=await m.json();if(!m.ok){q(m,b,e);return}u(e,b),_(r,t),E(o)}catch(i){console.error("Error during upload:",i),u(e,{type:"error",message:c("upload_failed")})}finally{A(e)}}),r.addEventListener("refreshRequest",function(a){const t=f(r);console.log("Refresh requested:",a),_(r,t)})});function f(r){const e=r.querySelector(".media-manager-config");if(!e)return null;try{return JSON.parse(e.value)}catch(a){return console.error(`Invalid JSON config for ${r.id}:`,a),null}}function v(r,e,a){var n,o,d,l;const t=e.closest(".media-manager-preview-media-container");return{"upload-media":a.media_upload_route,"upload-youtube-medium":a.youtube_upload_route,"temporary-upload-destroy":(n=t==null?void 0:t.dataset)==null?void 0:n.temporaryUploadDestroyRoute,"destroy-medium":(o=t==null?void 0:t.dataset)==null?void 0:o.destroyRoute,"set-as-first":(d=t==null?void 0:t.dataset)==null?void 0:d.setAsFirstRoute,"temporary-upload-set-as-first":(l=t==null?void 0:t.dataset)==null?void 0:l.temporaryUploadSetAsFirstRoute}[r]||null}function _(r,e){const a=r.querySelector(".media-manager-preview-grid");if(!a)return;const t=new URLSearchParams({model_type:e.model_type,model_id:e.model_id,image_collection:e.image_collection,youtube_collection:e.youtube_collection,document_collection:e.document_collection,initiator_id:e.id,frontend_theme:e.frontend_theme,destroy_enabled:e.destroy_enabled,set_as_first_enabled:e.set_as_first_enabled,show_media_url:e.show_media_url,show_order:e.show_order,temporary_uploads:e.temporary_upload});fetch(`${e.preview_update_route}?${t}`,{headers:{Accept:"application/json"}}).then(s=>s.json()).then(s=>{a.innerHTML=s.html,a.querySelectorAll("[data-image-editor-modal]").forEach(n=>{console.log("dispatch initializeImageEditorModal"),document.dispatchEvent(new CustomEvent("initializeImageEditorModal",{bubbles:!1,detail:{modal:n}}))})}).catch(s=>{console.error("Error refreshing media manager:",s)})}function S(r){const e=new FormData;return r.querySelectorAll("input").forEach(a=>{a.type==="file"?Array.from(a.files).forEach(t=>{e.append(a.name,t)}):e.append(a.name,a.value)}),e}function E(r){r.querySelectorAll("input").forEach(e=>{e.type!=="hidden"&&(e.value="")})}function w(r){var e;h(r),(e=r.querySelector("[data-spinner-container]"))==null||e.classList.add("active")}function A(r){var e;(e=r.querySelector("[data-spinner-container]"))==null||e.classList.remove("active")}function u(r,e){const{type:a,message:t,message_extra:s=null}=e,n=r.querySelector("[data-status-container]"),o=n==null?void 0:n.querySelector("[data-status-message]");if(!n||!o)return;const d=o.getAttribute("data-base-classes")||"",l=a==="success"?o.getAttribute("data-success-classes")||"":o.getAttribute("data-error-classes")||"";o.className=d,l.split(" ").forEach(i=>i&&o.classList.add(i)),o.textContent=t,s&&(o.textContent+=`

`+s),n.classList.add("visible"),clearTimeout(p),p=setTimeout(()=>h(r),5e3)}function h(r){var e;(e=r.querySelector("[data-status-container]"))==null||e.classList.remove("visible")}function q(r,e,a){let t=c("upload_failed");switch(r.status){case 419:t=c("csrf_token_mismatch");break;case 401:t=c("unauthenticated");break;case 403:t=c("forbidden");break;case 404:t=c("not_found");break;case 422:if(e.errors){Object.values(e.errors).flat().forEach(s=>{u(a,{type:"error",message:s})});return}t=e.message||c("validation_failed");break;case 429:t=c("too_many_requests");break;case 500:case 503:t=c("server_error");break;default:t=e.message||t}u(a,{type:"error",message:t})}function c(r){var e;return((e=window.mediaLibraryTranslations)==null?void 0:e[r])||r}});
