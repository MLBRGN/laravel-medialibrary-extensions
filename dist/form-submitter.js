document.addEventListener("DOMContentLoaded",function(){const h=document.querySelectorAll("[data-media-manager]");let f=null;h.forEach(t=>{const e=t.querySelector(".media-manager-row");t.addEventListener("click",async function(r){const a=g(t);if(!a)return;const s=r.target.closest("[data-action]");if(!s)return;r.preventDefault();const c=s.getAttribute("data-action");console.log("action",c);const o=s.closest("[data-xhr-form]"),l=(o==null?void 0:o.getAttribute("data-xhr-method"))??"post",m=b(c,s,a);if(!m){d(e,{type:"error",message:n("invalid_action")});return}A(e);try{const i=w(o);l.toLowerCase()==="delete"&&i.append("_method","DELETE"),l.toLowerCase()==="put"&&i.append("_method","PUT"),l.toLowerCase()==="patch"&&i.append("_method","PATCH");const p=await fetch(m,{method:"POST",headers:{"X-CSRF-TOKEN":a.csrf_token,Accept:"application/json"},body:i}),u=await p.json();if(!p.ok){L(p,u,e);return}d(e,u),v(t,a);const y=document.getElementById(`${o.dataset.target}-flash`);y&&u.message&&(y.innerHTML=`<div class="alert alert-${u.type}">${u.message}</div>`),S(o)}catch(i){console.error("Error during upload:",i),d(e,{type:"error",message:n("upload_failed")})}finally{E(e)}})});function g(t){const e=t.querySelector(".media-manager-config");if(!e)return null;try{return JSON.parse(e.value)}catch(r){return console.error(`Invalid JSON config for ${t.id}:`,r),null}}function b(t,e,r){const a=e.closest(".media-manager-preview-media-container"),s={"upload-media":r.media_upload_route,"upload-youtube-medium":r.youtube_upload_route};return a&&(s["temporary-upload-destroy"]=a.dataset.temporaryUploadDestroyRoute||"",s["destroy-medium"]=a.dataset.destroyRoute||"",s["set-as-first"]=a.dataset.setAsFirstRoute||"",s["temporary-upload-set-as-first"]=a.dataset.temporaryUploadSetAsFirstRoute||""),s[t]||null}function v(t,e){const r=t.querySelector(".media-manager-preview-grid");if(!r)return;const a=new URLSearchParams({model_type:e.model_type,model_id:e.model_id,image_collection:e.image_collection,youtube_collection:e.youtube_collection,document_collection:e.document_collection,initiator_id:e.id,frontend_theme:e.frontend_theme,destroy_enabled:e.destroy_enabled,set_as_first_enabled:e.set_as_first_enabled,show_media_url:e.show_media_url,show_order:e.show_order,temporary_uploads:e.temporary_upload});fetch(`${e.preview_update_route}?${a}`,{headers:{Accept:"application/json"}}).then(s=>s.json()).then(s=>{r.innerHTML=s.html}).catch(s=>{console.error("Error refreshing media manager:",s)})}function w(t){const e=new FormData;return t.querySelectorAll("input").forEach(r=>{r.type==="file"?Array.from(r.files).forEach(a=>{e.append(r.name,a)}):e.append(r.name,r.value)}),e}function S(t){t.querySelectorAll("input").forEach(e=>{e.type!=="hidden"&&(e.value="")})}function A(t){var e;_(t),(e=t.querySelector("[data-spinner-container]"))==null||e.classList.add("active")}function E(t){var e;(e=t.querySelector("[data-spinner-container]"))==null||e.classList.remove("active")}function d(t,e){const{type:r,message:a,message_extra:s=null}=e,c=t.querySelector("[data-status-container]"),o=c==null?void 0:c.querySelector("[data-status-message]");if(!c||!o)return;const l=o.getAttribute("data-base-classes")||"",m=r==="success"?o.getAttribute("data-success-classes")||"":o.getAttribute("data-error-classes")||"";o.className=l,m.split(" ").forEach(i=>i&&o.classList.add(i)),o.textContent=a,s&&(o.textContent+=`

`+s),c.classList.add("visible"),clearTimeout(f),f=setTimeout(()=>_(t),5e3)}function _(t){var e;(e=t.querySelector("[data-status-container]"))==null||e.classList.remove("visible")}function L(t,e,r){let a=n("upload_failed");switch(t.status){case 419:a=n("csrf_token_mismatch");break;case 401:a=n("unauthenticated");break;case 403:a=n("forbidden");break;case 404:a=n("not_found");break;case 422:if(e.errors){Object.values(e.errors).flat().forEach(s=>{d(r,{type:"error",message:s})});return}a=e.message||n("validation_failed");break;case 429:a=n("too_many_requests");break;case 500:case 503:a=n("server_error");break;default:a=e.message||a}d(r,{type:"error",message:a})}function n(t){var e;return((e=window.mediaLibraryTranslations)==null?void 0:e[t])||t}});
