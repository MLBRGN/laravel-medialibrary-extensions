import{s as u,t as y,a as g,h as E,b as q}from"./xhrStatus.js";document.addEventListener("DOMContentLoaded",function(){document.querySelectorAll("[data-media-manager]").forEach(t=>{const e=t.querySelector(".media-manager-row");t.addEventListener("click",async function(r){const o=m(t);if(!o)return;const l=r.target.closest("[data-action]");if(!l)return;r.preventDefault();const a=l.getAttribute("data-action");console.log("action",a);const n=l.closest("[data-xhr-form]"),d=(n==null?void 0:n.getAttribute("data-xhr-method"))??"post",s=b(a,l,o);if(!s){u(e,{type:"error",message:y("invalid_action")});return}g(e);try{const c=v(n),h=d.toUpperCase();["DELETE","PUT","PATCH"].includes(h)&&c.append("_method",h);const i=await fetch(s,{method:"POST",headers:{"X-CSRF-TOKEN":o.csrf_token,Accept:"application/json"},body:c}),_=await i.json();if(!i.ok){E(i,_,e);return}u(e,_),p(t,o),w(n)}catch(c){console.error("Error during upload:",c),u(e,{type:"error",message:y("upload_failed")})}finally{q(e)}}),t.addEventListener("refreshRequest",function(r){const o=m(t);console.log("Refresh requested:",r),p(t,o)})});function m(t){const e=t.querySelector(".media-manager-config");if(!e)return null;try{return JSON.parse(e.value)}catch(r){return console.error(`Invalid JSON config for ${t.id}:`,r),null}}function b(t,e,r){var a,n,d,s;const o=e.closest(".media-manager-preview-media-container");return{"upload-media":r.media_upload_route,"upload-youtube-medium":r.youtube_upload_route,"temporary-upload-destroy":(a=o==null?void 0:o.dataset)==null?void 0:a.temporaryUploadDestroyRoute,"destroy-medium":(n=o==null?void 0:o.dataset)==null?void 0:n.destroyRoute,"set-as-first":(d=o==null?void 0:o.dataset)==null?void 0:d.setAsFirstRoute,"temporary-upload-set-as-first":(s=o==null?void 0:o.dataset)==null?void 0:s.temporaryUploadSetAsFirstRoute}[t]||null}function p(t,e){console.log("update preview:",t);const r=t.querySelector(".media-manager-preview-grid"),o=t.querySelectorAll("form, [data-xhr-form]");if(!r)return;console.log("config",e);const l=new URLSearchParams({model_type:e.model_type,model_id:e.model_id,image_collection:e.image_collection,youtube_collection:e.youtube_collection,document_collection:e.document_collection,video_collection:e.video_collection,audio_collection:e.audio_collection,initiator_id:e.id,frontend_theme:e.frontend_theme,destroy_enabled:e.destroy_enabled,set_as_first_enabled:e.set_as_first_enabled,show_media_url:e.show_media_url,show_order:e.show_order,temporary_uploads:e.temporary_upload});fetch(`${e.preview_update_route}?${l}`,{headers:{Accept:"application/json"}}).then(async a=>{const n=await a.json();if(!a.ok){E(a,n);return}return n}).then(a=>{a.html&&(r.innerHTML=a.html,e.multiple||a.mediaCount!==void 0&&a.mediaCount!==null&&(a.mediaCount<1?A(o):S(o)),r.querySelectorAll("[data-image-editor-modal]").forEach(n=>{document.dispatchEvent(new CustomEvent("initializeImageEditorModal",{bubbles:!1,detail:{modal:n}}))}))}).catch(a=>{console.error("Error refreshing media manager:",a)})}function v(t){const e=new FormData;return t.querySelectorAll("input").forEach(r=>{r.type==="file"?Array.from(r.files).forEach(o=>{e.append(r.name,o)}):e.append(r.name,r.value)}),e}function w(t){t.querySelectorAll("input").forEach(e=>{e.type!=="hidden"&&(e.value="")})}function f(t,e){console.log("setFormElementsDisabled",t,"disabled",e),t.forEach(r=>{r.querySelectorAll('input:not([type="hidden"]), button').forEach(o=>o.disabled=e)})}function S(t){f(t,!0)}function A(t){f(t,!1)}});
