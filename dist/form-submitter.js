import{s as c,t as h,a as g,h as S,b as w}from"./xhrStatus.js";const A=document.querySelectorAll("[data-media-manager]");A.forEach(r=>{const e=r.querySelector("[data-media-manager-layout]");r.addEventListener("click",async function(o){const t=y(r);if(!t||!t.useXhr)return;const s=o.target.closest("[data-action]");if(!s)return;o.preventDefault();const a=s.getAttribute("data-action"),n=s.closest("[data-xhr-form]"),i=(n==null?void 0:n.getAttribute("data-xhr-method"))??"post",m=b(a,s,t);if(!m){c(e,{type:"error",message:h("invalid_action")});return}g(e);try{const d=R(n),p=i.toUpperCase();["DELETE","PUT","PATCH"].includes(p)&&d.append("_method",p);const u=await fetch(m,{method:"POST",headers:{"X-CSRF-TOKEN":t.csrfToken,Accept:"application/json"},body:d}),f=await u.json();if(!u.ok){S(u,f,e);return}c(e,f),E(r,t),F(n)}catch(d){console.error("Error during upload:",d),c(e,{type:"error",message:h("upload_failed")})}finally{w(e)}}),r.addEventListener("refreshRequest",function(o){const t=y(r);E(r,t)})});function y(r){const e=r.querySelector("[data-media-manager-config]");if(!e)return null;try{return JSON.parse(e.value)}catch(o){return console.error(`Invalid JSON config for ${r.id}:`,o),null}}function b(r,e,o){var s,a,n,i;const t=e.closest("[data-media-manager-preview-media-container]");return{"upload-media":o.mediaUploadRoute,"upload-youtube-medium":o.youtubeUploadRoute,"temporary-upload-destroy":(s=t==null?void 0:t.dataset)==null?void 0:s.temporaryUploadDestroyRoute,"destroy-medium":(a=t==null?void 0:t.dataset)==null?void 0:a.destroyRoute,"set-as-first":(n=t==null?void 0:t.dataset)==null?void 0:n.setAsFirstRoute,"temporary-upload-set-as-first":(i=t==null?void 0:t.dataset)==null?void 0:i.temporaryUploadSetAsFirstRoute}[r]||null}function E(r,e){var s;const o=r.querySelector("[data-media-manager-preview-grid]"),t=r.querySelectorAll("[data-form], [data-xhr-form]");if(!o)return;const l=new URLSearchParams({model_type:e.modelType,model_id:e.modelId,single_medium_id:((s=e.singleMedium)==null?void 0:s.id)??null,temporary_upload_mode:e.temporaryUploadMode,initiator_id:e.id,collections:JSON.stringify(e.collections),options:JSON.stringify(e.options)});fetch(`${e.previewUpdateRoute}?${l}`,{headers:{Accept:"application/json"}}).then(async a=>{const n=await a.json();if(!a.ok){S(a,n);return}return n}).then(a=>{a.html&&(o.innerHTML=a.html,e.multiple||a.mediaCount!==void 0&&a.mediaCount!==null&&(a.mediaCount<1?_(t):U(t)),document.dispatchEvent(new CustomEvent("mediaManagerPreviewsUpdated",{bubbles:!1,detail:{mediaManager:r,previewGrid:o}})))}).catch(a=>{console.error("Error refreshing media manager:",a)}).finally(()=>{})}function R(r){const e=new FormData;return r.querySelectorAll("input").forEach(o=>{o.type==="file"?Array.from(o.files).forEach(t=>{e.append(o.name,t)}):e.append(o.name,o.value)}),e}function F(r){r.querySelectorAll("input").forEach(e=>{e.type!=="hidden"&&(e.value="")})}function v(r,e){r.forEach(o=>{o.querySelectorAll('input:not([type="hidden"]), button').forEach(t=>t.disabled=e)})}function U(r){v(r,!0)}function _(r){v(r,!1)}
