import{s as u,t as p,a as E,h as g,b as v}from"./xhrStatus.js";const w=document.querySelectorAll("[data-media-manager]");w.forEach(t=>{const e=t.querySelector("[data-media-manager-layout]");t.addEventListener("click",async function(o){const r=h(t);if(!r||!r.useXhr)return;const a=o.target.closest("[data-action]");if(!a)return;o.preventDefault();const n=a.getAttribute("data-action");if(n==="debugger-toggle"){const l=r.id;console.log("componentId",l);const d=document.querySelector("#"+l).querySelector(".mle-debug");console.log("debugSection",d),d.classList.toggle("hidden"),console.log("toggle debugger TODO");return}const s=a.closest("[data-xhr-form]"),b=(s==null?void 0:s.getAttribute("data-xhr-method"))??"post",m=A(n,a,r);if(!m){u(e,{type:"error",message:p("invalid_action")});return}E(e);try{const l=q(s),c=b.toUpperCase();["DELETE","PUT","PATCH"].includes(c)&&l.append("_method",c);const d=await fetch(m,{method:"POST",headers:{"X-CSRF-TOKEN":r.csrfToken,Accept:"application/json"},body:l}),f=await d.json();if(!d.ok){g(d,f,e);return}u(e,f),y(t,r,{}),_(s)}catch(l){console.error("Error during upload:",l),u(e,{type:"error",message:p("upload_failed")})}finally{v(e)}}),t.addEventListener("refreshRequest",function(o){const r=o.detail,i=h(t);y(t,i,r)})});function h(t){const e=t.querySelector("[data-media-manager-config]");if(!e)return null;try{return JSON.parse(e.value)}catch(o){return console.error(`Invalid JSON config for ${t.id}:`,o),null}}function A(t,e,o){var i,a;console.log("target",e),console.log("config",o);const r={"upload-media":o.mediaUploadRoute,"upload-youtube-medium":o.youtubeUploadRoute,"destroy-medium":(i=e==null?void 0:e.dataset)==null?void 0:i.route,"set-as-first":(a=e==null?void 0:e.dataset)==null?void 0:a.route};return console.log("routes",r),r[t]||null}function y(t,e,o={}){const r=t.querySelector("[data-media-manager-preview-grid]"),i=t.querySelectorAll("[data-form], [data-xhr-form]");if(!r)return;const a=new URLSearchParams({model_type:e.modelType,model_id:e.modelId,single_medium_id:o.singleMediumId??null,temporary_upload_mode:e.temporaryUploadMode,initiator_id:e.id,collections:JSON.stringify(e.collections),options:JSON.stringify(e.options)});fetch(`${e.previewUpdateRoute}?${a}`,{headers:{Accept:"application/json"}}).then(async n=>{const s=await n.json();if(!n.ok){g(n,s);return}return s}).then(n=>{n.html&&(r.innerHTML=n.html,e.multiple||n.mediaCount!==void 0&&n.mediaCount!==null&&(n.mediaCount<1?C(i):T(i)),document.dispatchEvent(new CustomEvent("mediaManagerPreviewsUpdated",{bubbles:!1,detail:{mediaManager:t,previewGrid:r}})))}).catch(n=>{console.error("Error refreshing media manager:",n)}).finally(()=>{})}function q(t){const e=new FormData;return t.querySelectorAll("input").forEach(o=>{o.type==="file"?Array.from(o.files).forEach(r=>{e.append(o.name,r)}):e.append(o.name,o.value)}),e}function _(t){t.querySelectorAll("input").forEach(e=>{e.type!=="hidden"&&(e.value="")})}function S(t,e){t.forEach(o=>{o.querySelectorAll('input:not([type="hidden"]), button').forEach(r=>r.disabled=e)})}function T(t){S(t,!0)}function C(t){S(t,!1)}
