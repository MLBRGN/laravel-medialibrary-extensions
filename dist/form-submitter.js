document.addEventListener("DOMContentLoaded",function(){const y=document.querySelectorAll("[data-media-manager]");let f=null;y.forEach(t=>{const e=t.querySelector(".media-manager-form");t.addEventListener("click",async function(s){const a=h(t);if(!a)return;const r=s.target.closest("[data-action]");if(!r)return;s.preventDefault();const d=r.getAttribute("data-action"),i=r.closest("[data-xhr-form]"),c=b(d,r,a);if(!c){n(e,{type:"error",message:o("invalid_action")});return}w(e);try{const u=v(i),m=await fetch(c,{method:"POST",headers:{"X-CSRF-TOKEN":a.csrf_token,Accept:"application/json"},body:u}),l=await m.json();if(!m.ok){A(m,l,e);return}n(e,l),g(t,a);const p=document.getElementById(`${i.dataset.target}-flash`);p&&l.message&&(p.innerHTML=`<div class="alert alert-${l.type}">${l.message}</div>`),S(i)}catch(u){console.error("Error during upload:",u),n(e,{type:"error",message:o("upload_failed")})}finally{E(e)}})});function h(t){const e=t.querySelector(".media-manager-config");if(!e)return null;try{return JSON.parse(e.value)}catch(s){return console.error(`Invalid JSON config for ${t.id}:`,s),null}}function b(t,e,s){const a=e.closest(".media-manager-preview-media-container"),r={"upload-media":s.media_upload_route,"upload-youtube-medium":s.youtube_upload_route};return a&&(r["destroy-medium"]=a.dataset.destroyRoute||"",r["set-as-first"]=a.dataset.setAsFirstRoute||""),r[t]||null}function g(t,e){const s=t.querySelector(".media-manager-preview-grid");if(!s)return;const a=new URLSearchParams({model_type:e.model_type,model_id:e.model_id,image_collection:e.image_collection,youtube_collection:e.youtube_collection,document_collection:e.document_collection,initiator_id:e.id,frontend_theme:e.frontend_theme,destroy_enabled:e.destroy_enabled,set_as_first_enabled:e.set_as_first_enabled,show_media_url:e.show_media_url,show_order:e.show_order,temporary_uploads:e.temporary_upload});fetch(`${e.preview_update_route}?${a}`,{headers:{Accept:"application/json"}}).then(r=>r.json()).then(r=>{s.innerHTML=r.html}).catch(r=>{console.error("Error refreshing media manager:",r)})}function v(t){const e=new FormData;return t.querySelectorAll("input").forEach(s=>{s.type==="file"?Array.from(s.files).forEach(a=>{e.append(s.name,a)}):e.append(s.name,s.value)}),e}function S(t){t.querySelectorAll("input").forEach(e=>{e.type!=="hidden"&&(e.value="")})}function w(t){var e;_(t),(e=t.querySelector("[data-spinner-container]"))==null||e.classList.add("active")}function E(t){var e;(e=t.querySelector("[data-spinner-container]"))==null||e.classList.remove("active")}function n(t,{type:e,message:s}){const a=t.querySelector("[data-status-container]"),r=a==null?void 0:a.querySelector("[data-status-message]");if(!a||!r)return;const d=r.getAttribute("data-base-classes")||"",i=e==="success"?r.getAttribute("data-success-classes")||"":r.getAttribute("data-error-classes")||"";r.className=d,i.split(" ").forEach(c=>c&&r.classList.add(c)),r.textContent=s,a.classList.add("visible"),clearTimeout(f),f=setTimeout(()=>_(t),5e3)}function _(t){var e;(e=t.querySelector("[data-status-container]"))==null||e.classList.remove("visible")}function A(t,e,s){let a=o("upload_failed");switch(t.status){case 419:a=o("csrf_token_mismatch");break;case 401:a=o("unauthenticated");break;case 403:a=o("forbidden");break;case 404:a=o("not_found");break;case 422:if(e.errors){Object.values(e.errors).flat().forEach(r=>{n(s,{type:"error",message:r})});return}a=e.message||o("validation_failed");break;case 429:a=o("too_many_requests");break;case 500:case 503:a=o("server_error");break;default:a=e.message||a}n(s,{type:"error",message:a})}function o(t){var e;return((e=window.mediaLibraryTranslations)==null?void 0:e[t])||t}});
