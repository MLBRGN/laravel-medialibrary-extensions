import{a as u,t as p,s as E,h as S,b as v}from"./xhrStatus.js";const A=document.querySelectorAll("[data-media-manager]");A.forEach(t=>{const e=t.querySelector("[data-status-area-container]");console.log("statusAreaContainer",e),t.addEventListener("click",async function(o){const r=h(t);if(!r||!r.useXhr)return;const a=o.target.closest("[data-action]");if(!a)return;o.preventDefault();const n=a.getAttribute("data-action");if(n==="debugger-toggle"){const l=r.id;console.log("componentId",l);const d=document.querySelector("#"+l).querySelector(".mle-debug");console.log("debugSection",d),d.classList.toggle("hidden"),console.log("toggle debugger TODO");return}const i=a.closest("[data-xhr-form]"),g=(i==null?void 0:i.getAttribute("data-xhr-method"))??"post",m=w(n,a,r);if(!m){u(e,{type:"error",message:p("invalid_action")});return}E(e);try{const l=q(i),c=g.toUpperCase();["DELETE","PUT","PATCH"].includes(c)&&l.append("_method",c);const d=await fetch(m,{method:"POST",headers:{"X-CSRF-TOKEN":r.csrfToken,Accept:"application/json"},body:l}),f=await d.json();if(!d.ok){S(d,f,e);return}u(e,f),n!=="medium-restore"&&y(t,r,{}),C(i)}catch(l){console.error("Error during upload:",l),u(e,{type:"error",message:p("upload_failed")})}finally{v(e)}}),t.addEventListener("refreshRequest",function(o){const r=o.detail,s=h(t);y(t,s,r)})});function h(t){const e=t.querySelector("[data-media-manager-config]");if(!e)return null;try{return JSON.parse(e.value)}catch(o){return console.error(`Invalid JSON config for ${t.id}:`,o),null}}function w(t,e,o){var s,a,n;console.log("target",e),console.log("config",o);const r={"upload-media":o.mediaUploadRoute,"upload-youtube-medium":o.youtubeUploadRoute,"destroy-medium":(s=e==null?void 0:e.dataset)==null?void 0:s.route,"set-as-first":(a=e==null?void 0:e.dataset)==null?void 0:a.route,"medium-restore":(n=e==null?void 0:e.dataset)==null?void 0:n.route};return console.log("routes",r),r[t]||null}function y(t,e,o={}){const r=t.querySelector("[data-media-preview-grid]"),s=t.querySelectorAll("[data-form], [data-xhr-form]");if(!r)return;const a=new URLSearchParams({model_type:e.modelType,model_id:e.modelId,single_medium_id:o.singleMediumId??null,temporary_upload_mode:e.temporaryUploadMode,initiator_id:e.id,collections:JSON.stringify(e.collections),options:JSON.stringify(e.options)});fetch(`${e.previewUpdateRoute}?${a}`,{headers:{Accept:"application/json"}}).then(async n=>{const i=await n.json();if(!n.ok){S(n,i);return}return i}).then(n=>{n.html&&(r.innerHTML=n.html,e.multiple||n.mediaCount!==void 0&&n.mediaCount!==null&&(n.mediaCount<1?T(s):_(s)),document.dispatchEvent(new CustomEvent("mediaManagerPreviewsUpdated",{bubbles:!1,detail:{mediaManager:t,previewGrid:r}})))}).catch(n=>{console.error("Error refreshing media manager:",n)}).finally(()=>{})}function q(t){const e=new FormData;return t.querySelectorAll("input").forEach(o=>{o.type==="file"?Array.from(o.files).forEach(r=>{e.append(o.name,r)}):e.append(o.name,o.value)}),e}function C(t){t.querySelectorAll("input").forEach(e=>{e.type!=="hidden"&&(e.value="")})}function b(t,e){t.forEach(o=>{o.querySelectorAll('input:not([type="hidden"]), button').forEach(r=>r.disabled=e)})}function _(t){b(t,!0)}function T(t){b(t,!1)}
